---
interface Props {
  id: string
  file?: string
}

const { id, file } = Astro.props
const gistUrl = file
  ? `https://gist.github.com/${id}.js?file=${file}`
  : `https://gist.github.com/${id}.js`
---

<div class="gist-wrapper">
  <div class="gist-spinner" id={`spinner-${id.replace(/\//g, '-')}`}>
    <svg class="spinner-icon" viewBox="0 0 50 50">
      <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke-width="4"
      ></circle>
    </svg>
    <p>Loading content...</p>
  </div>
  <div class="gist-container" id={`gist-${id.replace(/\//g, '-')}`}></div>
</div>

<script is:inline define:vars={{ id, file }}>
  ;(function () {
    const gistId = id.replace(/\//g, '-')
    const spinner = document.getElementById(`spinner-${gistId}`)
    const container = document.getElementById(`gist-${gistId}`)

    // Use jsonp callback approach to load gist
    const callbackName = `gist_callback_${gistId.replace(/-/g, '_')}`

    // Override document.write temporarily
    const originalWrite = document.write
    let gistContent = ''

    document.write = function (content) {
      gistContent += content
    }

    // Create script element
    const script = document.createElement('script')
    const fileParam = file ? `?file=${file}` : ''
    script.src = `https://gist.github.com/${id}.js${fileParam}`

    const startTime = Date.now()

    script.onload = () => {
      // Restore original document.write
      document.write = originalWrite

      // Calculate how long to wait to meet minimum display time
      const elapsed = Date.now() - startTime
      const minDelay = 750
      const remainingDelay = Math.max(0, minDelay - elapsed)

      // Insert the captured content after minimum delay
      setTimeout(() => {
        if (gistContent) {
          container.innerHTML = gistContent
          spinner.style.display = 'none'
          container.style.opacity = '1'
        } else {
          spinner.innerHTML =
            '<p style="color: var(--theme-text-light);">Failed to load content. Please try again later.</p>'
        }
      }, remainingDelay)
    }

    script.onerror = () => {
      document.write = originalWrite
      if (spinner) {
        spinner.innerHTML =
          '<p style="color: var(--theme-text-light);">Failed to load content. Please try again later.</p>'
      }
    }

    // Append script to head to load the gist
    document.head.appendChild(script)
  })()
</script>

<style>
  .gist-wrapper {
    position: relative;
    margin: 0;
  }

  .gist-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    gap: 1rem;
  }

  .gist-spinner p {
    color: var(--theme-text-light);
    font-size: 0.95rem;
  }

  .spinner-icon {
    width: 3rem;
    height: 3rem;
    animation: rotate 2s linear infinite;
  }

  .spinner-path {
    stroke: var(--theme-accent);
    stroke-linecap: round;
    animation: dash 1.5s ease-in-out infinite;
  }

  @keyframes rotate {
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes dash {
    0% {
      stroke-dasharray: 1, 150;
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -35;
    }
    100% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -124;
    }
  }

  .gist-container {
    opacity: 0;
    transition: opacity 0.3s ease-in;
  }

  /* Base gist container */
  .gist-container :global(.gist) {
    font-family: var(--font-body) !important;
    font-size: 0.95rem !important;
    margin: 0 !important;
  }

  /* Gist file wrapper */
  .gist-container :global(.gist .gist-file) {
    border: 1px solid var(--theme-divider) !important;
    border-radius: 8px !important;
    background: var(--theme-bg) !important;
    overflow: hidden !important;
  }

  /* Gist data container */
  .gist-container :global(.gist .gist-data) {
    background: var(--theme-bg) !important;
    border-bottom: none !important;
    overflow: auto !important;
  }

  /* Markdown body */
  .gist-container :global(.gist .markdown-body) {
    background: var(--theme-bg) !important;
    color: var(--theme-foreground) !important;
    padding: 0 !important;
  }

  /* Headings */
  .gist-container :global(.gist .markdown-body h2),
  .gist-container :global(.gist .markdown-body .markdown-heading h2) {
    color: var(--theme-heading2) !important;
    border-bottom: 2px solid var(--theme-accent) !important;
    padding-bottom: 0.5rem !important;
    margin-top: 0 !important;
    margin-bottom: 1.5rem !important;
    font-size: 1.5rem !important;
  }

  .gist-container :global(.gist .markdown-body h2:first-child) {
    margin-top: 0 !important;
  }

  /* Hide anchor links */
  .gist-container :global(.gist .markdown-body .anchor),
  .gist-container :global(.gist .markdown-body .octicon) {
    display: none !important;
  }

  /* Table wrapper */
  .gist-container :global(.gist markdown-accessiblity-table),
  .gist-container :global(.gist .markdown-body table) {
    width: 100% !important;
    margin: 0 !important;
    display: table !important;
  }

  /* Table styling */
  .gist-container :global(.gist table) {
    width: 100% !important;
    border-collapse: collapse !important;
    background: var(--theme-bg) !important;
    color: var(--theme-text) !important;
    font-size: 0.9rem !important;
    border: none !important;
    margin-bottom: 2rem !important;
  }

  /* Table head */
  .gist-container :global(.gist thead) {
    background: var(--theme-bg-offset) !important;
  }

  .gist-container :global(.gist thead tr) {
    background: var(--theme-bg-offset) !important;
    border-bottom: 2px solid var(--theme-accent) !important;
  }

  .gist-container :global(.gist th) {
    padding: 1rem 0.75rem !important;
    text-align: left !important;
    font-weight: 600 !important;
    background: var(--theme-bg-offset) !important;
    color: var(--theme-foreground) !important;
    border: none !important;
    text-transform: uppercase !important;
    font-size: 0.85rem !important;
    letter-spacing: 0.05em !important;
  }

  /* Table body */
  .gist-container :global(.gist tbody) {
    background: var(--theme-bg) !important;
  }

  .gist-container :global(.gist tbody tr) {
    background: var(--theme-bg) !important;
    border-bottom: 1px solid var(--theme-divider) !important;
    transition: background-color 0.2s ease !important;
  }

  .gist-container :global(.gist tbody tr:hover) {
    background: var(--theme-bg-hover) !important;
  }

  .gist-container :global(.gist tbody tr:hover td) {
    background: var(--theme-bg-hover) !important;
  }

  .gist-container :global(.gist tbody tr:last-child) {
    border-bottom: none !important;
  }

  .gist-container :global(.gist td) {
    padding: 1rem 0.75rem !important;
    text-align: left !important;
    border: none !important;
    color: var(--theme-foreground) !important;
    background: var(--theme-bg) !important;
    vertical-align: top !important;
  }

  /* Links */
  .gist-container :global(.gist td a),
  .gist-container :global(.gist .markdown-body a) {
    color: var(--theme-accent) !important;
    text-decoration: none !important;
    transition: color 0.2s ease !important;
  }

  .gist-container :global(.gist td a:hover),
  .gist-container :global(.gist .markdown-body a:hover) {
    color: var(--theme-text) !important;
    text-decoration: underline !important;
  }

  /* Code blocks */
  .gist-container :global(.gist td code),
  .gist-container :global(.gist .markdown-body code) {
    background: var(--theme-code-inline-bg) !important;
    padding: 0.125rem 0.375rem !important;
    border-radius: 3px !important;
    font-size: 0.9em !important;
    color: var(--theme-foreground) !important;
    font-family: var(--font-mono) !important;
  }

  /* Gist meta footer */
  .gist-container :global(.gist .gist-meta) {
    background: var(--theme-bg-offset) !important;
    color: var(--theme-text-light) !important;
    border-top: 1px solid var(--theme-divider) !important;
    padding: 0.75rem 1rem !important;
    font-size: 0.85rem !important;
  }

  .gist-container :global(.gist .gist-meta a) {
    color: var(--theme-accent) !important;
    text-decoration: none !important;
  }

  .gist-container :global(.gist .gist-meta a:hover) {
    color: var(--theme-text) !important;
    text-decoration: underline !important;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .gist-container :global(.gist .markdown-body) {
      padding: 1rem !important;
    }

    .gist-container :global(.gist table) {
      font-size: 0.85rem !important;
    }

    .gist-container :global(.gist th),
    .gist-container :global(.gist td) {
      padding: 0.75rem 0.5rem !important;
    }
  }
</style>
