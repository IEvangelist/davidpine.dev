---
import IconChevronUp from '~/icons/chevron-up.svg'

interface Props {
  /**
   * CSS selector for the element to scroll to when clicked.
   * If not provided, scrolls to the first h1 element or top of page.
   * Use "top" to always scroll to the very top of the page.
   */
  scrollToSelector?: string
  /**
   * CSS selector for the element to observe for showing/hiding the button.
   * Defaults to 'article div.prose'.
   */
  observeSelector?: string
}

const { 
  scrollToSelector,
  observeSelector = 'article div.prose'
} = Astro.props
---

<button
  hidden
  class="scroll-up size-11 fixed flex items-center justify-center bg-background z-100 bottom-3 right-3 rounded-full border-2 border-accent/20 hover:bg-accent/10 md:size-12 md:bottom-5 md:right-5 lg:size-13 lg:bottom-6 lg:right-6"
  data-scroll-to={scrollToSelector}
  data-observe={observeSelector}
>
  <IconChevronUp class="text-accent/50 size-8 lg:size-9" />
</button>

<script>
  function transitionHiddenElement(
    element: HTMLElement,
    transitionProperty: string,
    transitionClass: string,
  ) {
    const listener = (e: TransitionEvent) => {
      if (e.target === element && e.propertyName === transitionProperty) {
        element.setAttribute('hidden', 'true')
        element.removeEventListener('transitionend', listener)
      }
    }
    return {
      show() {
        element.removeEventListener('transitionend', listener)
        element.removeAttribute('hidden')
        // Force a browser re-paint
        const _reflow = element.offsetHeight
        element.classList.add(transitionClass)
      },
      hide() {
        element.addEventListener('transitionend', listener)
        element.classList.remove(transitionClass)
      },
    }
  }

  function init() {
    const button = document.querySelector('button.scroll-up') as HTMLButtonElement
    if (!button) {
      console.warn('Scroll up button not found in the document.')
      return
    }

    const scrollToSelector = button.dataset.scrollTo
    const observeSelector = button.dataset.observe || 'article div.prose'

    // Determine scroll target
    let scrollToOffset = 0
    if (scrollToSelector === 'top') {
      scrollToOffset = 0
    } else if (scrollToSelector) {
      const targetElement = document.querySelector(scrollToSelector)
      scrollToOffset = targetElement ? (targetElement as HTMLElement).offsetTop : 0
    } else {
      const topHeading = document.querySelector('h1')
      scrollToOffset = topHeading ? topHeading.offsetTop : 0
    }

    button.addEventListener('click', () => {
      window.scrollTo({ top: scrollToOffset, behavior: 'smooth' })
    })

    // Use IntersectionObserver to show/hide the button
    const observeElement = document.querySelector(observeSelector)
    if (!observeElement) {
      console.warn(`Observe element not found: ${observeSelector}`)
      return
    }

    const btnControl = transitionHiddenElement(button, 'opacity', 'active')

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            btnControl.show()
          } else {
            btnControl.hide()
          }
        })
      },
      // Only consider the top 5% of the viewport
      { rootMargin: `0px 0px -95% 0px` },
    )
    observer.observe(observeElement)
  }

  init()
</script>

<style>
  /* When button appears, slide it in from the bottom */
  button.scroll-up {
    /* also add a translate effect */
    transform: translateY(0px);
    /* and a transition */
    opacity: 1;
    transition:
      transform 0.3s ease-in-out,
      opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  }
  button.scroll-up:not(.active) {
    transform: translateY(10px);
    opacity: 0;
  }
</style>
